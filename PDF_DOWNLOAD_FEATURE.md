# âœ… PDF Download Feature - Tagesbericht & Regiescheine

## Overview

Added PDF download buttons for Tagesbericht and Regiescheine. PDFs are generated by the mobile app and stored in S3 bucket. PM tool fetches presigned URLs from the mobile app backend and displays download buttons.

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PM Tool Frontend                      â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   Tagesbericht      â”‚  [Download PDF] â†â”€â”€  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  Regieschein #1     â”‚  [Download PDF] â†â”€â”€  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Click PDF button
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         window.open(pdfUrl, '_blank')          â”‚
â”‚                                                 â”‚
â”‚  Opens presigned S3 URL in new tab             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Amazon S3 Bucket                     â”‚
â”‚                                                 â”‚
â”‚  â€¢ PDF generated by mobile app                 â”‚
â”‚  â€¢ Presigned URL valid for 10 minutes          â”‚
â”‚  â€¢ Direct download, no auth needed             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### 1. User Opens Tagesdetail Page

```
Frontend requests: GET /api/employees/{id}/tagesdetail/{date}
    â†“
PM Tool Backend (TagesdetailService):
  1. Fetch submissions from Mobile App
  2. For each submission:
     - Fetch SubmissionDetail (includes pdfUrl)
     - Build FormWithSubmissionDto
     - Include pdfUrl in response
    â†“
Frontend receives:
  {
    tagesbericht: {
      submissionId: "...",
      formDefinition: {...},
      data: {...},
      pdfUrl: "https://s3.amazonaws.com/bucket/file.pdf?presigned..."  â† S3 URL!
    },
    regiescheine: [
      {
        submissionId: "...",
        pdfUrl: "https://s3.amazonaws.com/..."  â† Each has its own PDF
      }
    ]
  }
```

### 2. User Clicks PDF Download Button

```
User clicks "PDF" button
    â†“
handleDownloadPdf(pdfUrl, formName) called
    â†“
window.open(pdfUrl, '_blank')
    â†“
Browser opens new tab with presigned S3 URL
    â†“
S3 serves PDF file directly (no auth needed, presigned!)
    â†“
User downloads or views PDF âœ…
```

---

## Implementation

### Backend Changes

#### 1. FormBackendClient.java - Added pdfUrl Field

```java
public record SubmissionDetail(
    String id,
    String formId,
    String formName,
    // ... other fields ...
    String pdfUrl  // â† Added
) {}
```

#### 2. FormWithSubmissionDto.java - Added pdfUrl Field

```java
public record FormWithSubmissionDto(
    FormDefinitionDto formDefinition,
    UUID submissionId,
    Map<String, Object> data,
    Map<String, Object> originalData,
    boolean hasChanges,
    UUID formId,
    String formVersion,
    Instant submittedAt,
    String submittedBy,
    SubmissionStatus status,
    String pdfUrl  // â† Added
) {}
```

#### 3. TagesdetailService.java - Pass pdfUrl Through

```java
return new FormWithSubmissionDto(
    formDefDto,
    submissionId,
    displayedData,
    detail.data(),
    hasChanges,
    formId,
    String.valueOf(formDef.version()),
    detail.submittedAt(),
    detail.employeeUsername(),
    mapStatus(detail.status()),
    detail.pdfUrl()  // â† Pass through from mobile app
);
```

---

### Frontend Changes

#### 1. types/tagesdetail.ts - Added pdfUrl Type

```typescript
export interface FormWithSubmission {
  formDefinition: FormDefinition
  submissionId: string
  data: Record<string, any>
  originalData: Record<string, any>
  hasChanges: boolean
  formId: string
  formVersion: string
  submittedAt: string
  submittedBy: string
  status: "DRAFT" | "SUBMITTED" | "APPROVED" | "REJECTED"
  pdfUrl: string  // â† Added
}
```

#### 2. page.tsx - Added Download Handler

```typescript
const handleDownloadPdf = (pdfUrl: string, formName: string) => {
  if (!pdfUrl) {
    toast({
      title: "Fehler",
      description: "PDF-URL nicht verfÃ¼gbar",
      variant: "destructive",
    })
    return
  }
  
  // Open PDF in new tab (presigned URL allows direct access)
  window.open(pdfUrl, '_blank')
}
```

#### 3. page.tsx - Tagesbericht Download Button

```tsx
<CardHeader>
  <div className="flex items-center justify-between">
    <CardTitle className="text-lg flex items-center gap-2">
      ğŸ“‹ Tagesbericht
    </CardTitle>
    {tagesdetail.tagesbericht?.pdfUrl && (
      <Button
        variant="outline"
        size="sm"
        onClick={() => handleDownloadPdf(
          tagesdetail.tagesbericht!.pdfUrl,
          tagesdetail.tagesbericht!.formDefinition.name
        )}
      >
        <Download className="h-4 w-4 mr-2" />
        PDF
      </Button>
    )}
  </div>
</CardHeader>
```

#### 4. page.tsx - Regieschein Download Buttons

```tsx
{tagesdetail.regiescheine.map((rs, idx) => (
  <div key={rs.submissionId}>
    <div className="flex items-center justify-between mb-3">
      <div className="text-sm font-medium">
        Regieschein #{idx + 1}
      </div>
      {rs.pdfUrl && (
        <Button
          variant="outline"
          size="sm"
          onClick={() => handleDownloadPdf(rs.pdfUrl, rs.formDefinition.name)}
        >
          <Download className="h-4 w-4 mr-2" />
          PDF
        </Button>
      )}
    </div>
    <DynamicFormRenderer ... />
  </div>
))}
```

---

## UI/UX

### Tagesbericht Card

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Tagesbericht              [PDF] â†â”€â”€â”€   â”‚  Button in header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Start Zeit: 08:00                         â”‚
â”‚  End Zeit: 16:00                           â”‚
â”‚  ...                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Regiescheine Card

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ Regiescheine                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Regieschein #1                  [PDF] â†â”€â”€ â”‚  Button per item
â”‚  Material: Beton                           â”‚
â”‚  Menge: 100                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  Regieschein #2                  [PDF] â†â”€â”€ â”‚  Each has own button
â”‚  Material: Stahl                           â”‚
â”‚  Menge: 50                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Button Styling

- **Variant:** `outline` (subtle, doesn't overpower the content)
- **Size:** `sm` (compact, fits in header/inline)
- **Icon:** `Download` icon from lucide-react
- **Hover:** Border and text turn to `montron-primary` color
- **Only shown if:** `pdfUrl` exists (conditional rendering)

---

## How S3 Presigned URLs Work

### What is a Presigned URL?

A presigned URL is a time-limited URL that grants temporary access to a private S3 object without requiring AWS credentials.

### Example Presigned URL

```
https://my-bucket.s3.amazonaws.com/submissions/abc-123.pdf?
  X-Amz-Algorithm=AWS4-HMAC-SHA256&
  X-Amz-Credential=AKIAIOSFODNN7EXAMPLE/20251207/us-east-1/s3/aws4_request&
  X-Amz-Date=20251207T000000Z&
  X-Amz-Expires=600&  â† Valid for 10 minutes (600 seconds)
  X-Amz-SignedHeaders=host&
  X-Amz-Signature=abc123...
```

### Benefits

1. **Secure** - No AWS credentials exposed
2. **Time-limited** - URL expires after 10 minutes (configurable)
3. **Direct access** - No proxy needed, S3 serves directly
4. **Fast** - No processing, straight from S3 CDN

### Security

- âœ… PM tool doesn't need S3 credentials
- âœ… Frontend gets temporary URL from backend
- âœ… URL expires after `presign-ttl-seconds` (default: 600s = 10 min)
- âœ… After expiration, user must refresh page to get new URL

---

## Configuration

### Mobile App Backend (S3 Presigned URL TTL)

**File:** `application.yml`

```yaml
presign-ttl-seconds: 600  # 10 minutes
```

**What it controls:**
- How long the presigned URL is valid
- After this time, URL expires and user must refresh page

**Recommendation:**
- **10 minutes** (600s) - Good balance
- Too short â†’ Users complain URLs expire too fast
- Too long â†’ Security risk if URL is shared

---

## Error Handling

### Case 1: PDF Not Generated Yet

```tsx
{tagesdetail.tagesbericht?.pdfUrl && (
  <Button onClick={...}>PDF</Button>
)}
```

- If `pdfUrl` is `null` or `undefined`, button is **not rendered**
- User won't see a broken button

### Case 2: Invalid/Expired URL

```typescript
const handleDownloadPdf = (pdfUrl: string, formName: string) => {
  if (!pdfUrl) {
    toast({
      title: "Fehler",
      description: "PDF-URL nicht verfÃ¼gbar",
      variant: "destructive",
    })
    return
  }
  
  window.open(pdfUrl, '_blank')
}
```

- If URL is expired, S3 will return 403 Forbidden
- User sees browser error (S3 error page)
- **Solution:** User refreshes Tagesdetail page to get new presigned URL

### Case 3: Network Error

- Browser handles network errors automatically
- User sees browser's standard download failure message

---

## Testing Checklist

### âœ… Test 1: Tagesbericht PDF Download
1. Open Tagesdetail page with Tagesbericht
2. **Verify:** "PDF" button visible in Tagesbericht header
3. Click "PDF" button
4. **Verify:** New tab opens with PDF
5. **Verify:** PDF downloads or displays

### âœ… Test 2: Regieschein PDF Download
1. Open page with multiple Regiescheine
2. **Verify:** Each Regieschein has "PDF" button
3. Click "PDF" on Regieschein #1
4. **Verify:** Correct PDF opens (matches Regieschein #1)
5. Click "PDF" on Regieschein #2
6. **Verify:** Correct PDF opens (matches Regieschein #2)

### âœ… Test 3: No PDF Available
1. Create submission without PDF (if possible)
2. **Verify:** No "PDF" button shown
3. **Verify:** No error messages
4. **Verify:** Page still works normally

### âœ… Test 4: URL Expiration
1. Open Tagesdetail page
2. Copy PDF URL from network tab
3. Wait 11 minutes (past expiration)
4. Try to open copied URL
5. **Verify:** S3 returns 403 Forbidden
6. Refresh Tagesdetail page
7. Click "PDF" button again
8. **Verify:** New URL works (fresh presigned URL)

### âœ… Test 5: Multiple Submissions
1. Open page with 1 Tagesbericht + 3 Regiescheine
2. **Verify:** 4 "PDF" buttons total (1 + 3)
3. Click each button
4. **Verify:** Each opens correct PDF

---

## Future Enhancements

### 1. Download Instead of Open
Currently: `window.open(pdfUrl, '_blank')` â†’ Opens in new tab

**Could add:**
```typescript
const link = document.createElement('a')
link.href = pdfUrl
link.download = `${formName}_${date}.pdf`  // Force download
link.click()
```

### 2. Download Progress
For large PDFs, show download progress:
```tsx
const [downloading, setDownloading] = useState(false)

<Button disabled={downloading}>
  {downloading ? "LÃ¤dt..." : "PDF"}
</Button>
```

### 3. Batch Download
Download all PDFs (Tagesbericht + all Regiescheine) as ZIP:
```tsx
<Button onClick={handleDownloadAll}>
  Alle PDFs herunterladen
</Button>
```

### 4. Preview Modal
Instead of new tab, show PDF in modal:
```tsx
<Dialog>
  <iframe src={pdfUrl} />
</Dialog>
```

---

## Summary

### âœ… What We Added
1. **pdfUrl field** in backend DTOs
2. **Download buttons** in Tagesbericht and Regieschein cards
3. **Simple click handler** to open PDF in new tab
4. **Conditional rendering** - only show button if PDF exists

### âœ… How It Works
1. Mobile app generates PDF â†’ uploads to S3
2. Mobile app stores S3 object key in database
3. When PM tool requests submission, mobile app generates presigned URL
4. PM tool passes URL to frontend
5. Frontend shows download button
6. User clicks â†’ PDF opens in new tab âœ…

### âœ… Benefits
- **No file storage** in PM tool - S3 handles it
- **Secure** - presigned URLs expire after 10 minutes
- **Fast** - direct download from S3 CDN
- **Simple** - no complex upload/download logic needed

---

**Status:** âœ… Complete - Restart PM tool backend and test!

